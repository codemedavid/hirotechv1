// Messenger Bulk Messaging Platform Database Schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// ORGANIZATION & USER MANAGEMENT
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users         User[]
  contacts      Contact[]
  campaigns     Campaign[]
  templates     Template[]
  facebookPages FacebookPage[]
  pipelines     Pipeline[]
  tags          Tag[]
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  password       String?
  name           String?
  image          String?
  role           Role         @default(AGENT)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  campaigns      Campaign[]
  conversations  Conversation[]
  activities     ContactActivity[]
}

enum Role {
  ADMIN
  MANAGER
  AGENT
}

// ============================================
// FACEBOOK & INSTAGRAM INTEGRATION
// ============================================

model FacebookPage {
  id                  String       @id @default(cuid())
  organizationId      String
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Facebook Page
  pageId              String       @unique
  pageName            String
  pageAccessToken     String       // Should be encrypted in production
  
  // Instagram Business (connected to page)
  instagramAccountId  String?      @unique
  instagramUsername   String?
  
  // Sync settings
  autoSync            Boolean      @default(true)
  syncInterval        Int          @default(3600) // seconds
  lastSyncedAt        DateTime?
  
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  contacts            Contact[]
  conversations       Conversation[]
  campaigns           Campaign[]
}

// ============================================
// CONTACTS & TAGS
// ============================================

model Contact {
  id             String       @id @default(cuid())
  
  // Platform identifiers
  messengerPSID  String?      // Page-Scoped ID for Messenger
  instagramSID   String?      // Instagram-Scoped ID
  
  // Contact info from Graph API
  firstName      String
  lastName       String?
  profilePicUrl  String?
  locale         String?
  timezone       Int?
  
  // Which platforms they're on
  hasMessenger   Boolean      @default(false)
  hasInstagram   Boolean      @default(false)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  facebookPageId String
  facebookPage   FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  // Pipeline tracking
  pipelineId     String?
  pipeline       Pipeline?    @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  
  stageId        String?
  stage          PipelineStage? @relation(fields: [stageId], references: [id], onDelete: SetNull)
  
  stageEnteredAt DateTime?
  
  // Lead scoring
  leadScore      Int          @default(0)
  leadStatus     LeadStatus   @default(NEW)
  
  tags           String[]
  notes          String?      @db.Text
  aiContext      String?      @db.Text
  aiContextUpdatedAt DateTime?
  lastInteraction DateTime?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  groups         ContactGroup[]
  messages       Message[]
  conversations  Conversation[]
  activities     ContactActivity[]
  
  @@unique([messengerPSID, facebookPageId])
  @@index([instagramSID])
  @@index([pipelineId, stageId])
  @@index([leadStatus])
  @@index([organizationId])
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATING
  WON
  LOST
  UNRESPONSIVE
}

model Tag {
  id             String   @id @default(cuid())
  name           String
  description    String?
  color          String   @default("#64748b")
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  contactCount   Int      @default(0)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([organizationId, name])
  @@index([organizationId])
}

model ContactGroup {
  id          String    @id @default(cuid())
  name        String
  description String?
  color       String?
  contacts    Contact[]
  campaigns   Campaign[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================
// PIPELINE SYSTEM
// ============================================

model Pipeline {
  id             String   @id @default(cuid())
  name           String
  description    String?
  color          String   @default("#3b82f6")
  icon           String?
  isDefault      Boolean  @default(false)
  isArchived     Boolean  @default(false)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  stages         PipelineStage[]
  contacts       Contact[]
  automations    PipelineAutomation[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([organizationId, isArchived])
}

model PipelineStage {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#64748b")
  order       Int
  
  type        StageType @default(IN_PROGRESS)
  
  pipelineId  String
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  contacts    Contact[]
  activities  ContactActivity[] @relation("toStage")
  fromActivities ContactActivity[] @relation("fromStage")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([pipelineId, order])
  @@index([pipelineId])
}

enum StageType {
  LEAD
  IN_PROGRESS
  WON
  LOST
  ARCHIVED
}

model ContactActivity {
  id          String   @id @default(cuid())
  
  contactId   String
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  type        ActivityType
  
  title       String
  description String?
  metadata    Json?
  
  fromStageId String?
  fromStage   PipelineStage? @relation(fields: [fromStageId], references: [id], name: "fromStage", onDelete: SetNull)
  
  toStageId   String?
  toStage     PipelineStage? @relation(fields: [toStageId], references: [id], name: "toStage", onDelete: SetNull)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  
  @@index([contactId, createdAt])
  @@index([type])
}

enum ActivityType {
  NOTE_ADDED
  STAGE_CHANGED
  STATUS_CHANGED
  TAG_ADDED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  CAMPAIGN_SENT
  TASK_CREATED
  TASK_COMPLETED
  CALL_MADE
  EMAIL_SENT
}

model PipelineAutomation {
  id          String   @id @default(cuid())
  name        String
  description String?
  isActive    Boolean  @default(true)
  
  pipelineId  String
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  
  triggerType AutomationTrigger
  triggerConditions Json
  
  actions     Json
  
  timesTriggered Int    @default(0)
  lastTriggeredAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([pipelineId, isActive])
}

enum AutomationTrigger {
  STAGE_ENTERED
  STAGE_DURATION
  MESSAGE_RECEIVED
  NO_ACTIVITY
  TAG_ADDED
  LEAD_SCORE_REACHED
}

// ============================================
// CAMPAIGNS & TEMPLATES
// ============================================

model Campaign {
  id             String       @id @default(cuid())
  name           String
  description    String?
  status         CampaignStatus @default(DRAFT)
  
  platform       Platform
  messageTag     MessageTag?
  
  facebookPageId String
  facebookPage   FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdById    String
  createdBy      User         @relation(fields: [createdById], references: [id])
  
  templateId     String?
  template       Template?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  targetingType  TargetingType @default(CONTACT_GROUPS)
  
  groups         ContactGroup[]
  targetContactIds String[]
  targetTags     String[]
  targetStageIds String[]
  targetFilters  Json?
  
  rateLimit      Int          @default(3600) // 1 message per second (3600/hour) - was 100 which caused 36 second delays
  
  totalRecipients Int         @default(0)
  sentCount       Int         @default(0)
  deliveredCount  Int         @default(0)
  readCount       Int         @default(0)
  failedCount     Int         @default(0)
  repliedCount    Int         @default(0)
  
  messages       Message[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([status, platform])
  @@index([organizationId])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  COMPLETED
}

enum TargetingType {
  CONTACT_GROUPS
  TAGS
  PIPELINE_STAGES
  SPECIFIC_CONTACTS
  ADVANCED_FILTERS
  ALL_CONTACTS
}

enum Platform {
  MESSENGER
  INSTAGRAM
}

enum MessageTag {
  CONFIRMED_EVENT_UPDATE
  POST_PURCHASE_UPDATE
  ACCOUNT_UPDATE
  HUMAN_AGENT
}

model Template {
  id             String       @id @default(cuid())
  name           String
  content        String       @db.Text
  variables      String[]
  platform       Platform
  category       String?
  
  recommendedTag MessageTag?
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  campaigns      Campaign[]
  usageCount     Int          @default(0)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

// ============================================
// MESSAGES & CONVERSATIONS
// ============================================

model Conversation {
  id             String              @id @default(cuid())
  
  contactId      String
  contact        Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  facebookPageId String
  facebookPage   FacebookPage        @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)
  
  platform       Platform
  status         ConversationStatus  @default(OPEN)
  lastMessageAt  DateTime
  
  assignedToId   String?
  assignedTo     User?               @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  
  messages       Message[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  
  @@index([status, platform])
  @@index([lastMessageAt])
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  ARCHIVED
}

model Message {
  id          String        @id @default(cuid())
  content     String        @db.Text
  platform    Platform
  status      MessageStatus @default(PENDING)
  
  messageTag  MessageTag?
  
  facebookMessageId String?
  
  contactId   String
  contact     Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  campaignId  String?
  campaign    Campaign?     @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  isFromBusiness Boolean    @default(true)
  
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  failedAt    DateTime?
  errorMessage String?
  
  createdAt   DateTime      @default(now())
  
  @@index([campaignId, status])
  @@index([conversationId, createdAt])
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// WEBHOOK EVENTS
// ============================================

model WebhookEvent {
  id         String   @id @default(cuid())
  platform   Platform
  eventType  String
  payload    Json
  processed  Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@index([processed, createdAt])
}

// ============================================
// SYNC JOBS
// ============================================

model SyncJob {
  id             String    @id @default(cuid())
  facebookPageId String
  status         SyncJobStatus @default(PENDING)
  
  totalContacts  Int       @default(0)
  syncedContacts Int       @default(0)
  failedContacts Int       @default(0)
  
  errors         Json?
  tokenExpired   Boolean   @default(false)
  
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@index([facebookPageId, status])
  @@index([status, createdAt])
}

enum SyncJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

