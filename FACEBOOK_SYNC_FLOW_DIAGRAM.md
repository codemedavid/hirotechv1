# ğŸ”„ Facebook Page Syncing - Visual Flow Diagram

## ğŸ“Š Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚                         ğŸ‘¤ USER INTERACTION                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Settings > Integrations > Connected Facebook Pages                â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  ğŸ“˜ My Business Page                                         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ 347 contacts                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ Last synced: 2 hours ago                                 â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ [ğŸ”„ Sync Contacts]  [âš™ï¸ Settings]  [ğŸ—‘ï¸ Disconnect]      â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  User clicks "Sync Contacts" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
                                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚                         ğŸŒ API LAYER                                         â”‚
â”‚                                                                              â”‚
â”‚  POST /api/facebook/sync-background                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  1. âœ… Verify user authentication                                â”‚       â”‚
â”‚  â”‚  2. ğŸ” Check for existing active sync job                        â”‚       â”‚
â”‚  â”‚     â”œâ”€ Found? â†’ Return existing jobId                            â”‚       â”‚
â”‚  â”‚     â””â”€ Not found? â†’ Continue...                                  â”‚       â”‚
â”‚  â”‚  3. ğŸ’¾ Create new SyncJob in database                            â”‚       â”‚
â”‚  â”‚     â”œâ”€ status: PENDING                                           â”‚       â”‚
â”‚  â”‚     â”œâ”€ facebookPageId: "clx123..."                              â”‚       â”‚
â”‚  â”‚     â””â”€ createdAt: now()                                          â”‚       â”‚
â”‚  â”‚  4. ğŸš€ Start executeBackgroundSync() (fire-and-forget)          â”‚       â”‚
â”‚  â”‚  5. âš¡ Return immediately to user                                â”‚       â”‚
â”‚  â”‚     â””â”€ { success: true, jobId: "clx456..." }                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â”‚  â¬…ï¸ Response returned to user immediately (< 100ms)                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ User sees: "âœ… Sync started - continuing in background"
                 â”‚ UI begins polling every 2 seconds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                                    â”‚
                 â–¼                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ BACKGROUND SYNC ENGINE               â”‚  â”‚  ğŸ“Š PROGRESS POLLING             â”‚
â”‚  (Runs on server, continues even if     â”‚  â”‚                                  â”‚
â”‚   user closes browser)                  â”‚  â”‚  GET /api/facebook/sync-status/  â”‚
â”‚                                          â”‚  â”‚      {jobId}                     â”‚
â”‚  executeBackgroundSync() starts:        â”‚  â”‚                                  â”‚
â”‚                                          â”‚  â”‚  Every 2 seconds:                â”‚
â”‚  1ï¸âƒ£ Update job status                   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚     PENDING â†’ IN_PROGRESS                â”‚  â”‚  â”‚ Query SyncJob table        â”‚ â”‚
â”‚     startedAt = now()                    â”‚  â”‚  â”‚ Return current progress    â”‚ â”‚
â”‚                                          â”‚  â”‚  â”‚ {                          â”‚ â”‚
â”‚  2ï¸âƒ£ Fetch FacebookPage from DB          â”‚  â”‚  â”‚   status: "IN_PROGRESS",   â”‚ â”‚
â”‚     â”œâ”€ pageAccessToken                   â”‚  â”‚  â”‚   syncedContacts: 145,     â”‚ â”‚
â”‚     â”œâ”€ autoPipelineId                    â”‚  â”‚  â”‚   failedContacts: 3,       â”‚ â”‚
â”‚     â””â”€ autoPipeline.stages               â”‚  â”‚  â”‚   startedAt: "..."         â”‚ â”‚
â”‚                                          â”‚  â”‚  â”‚ }                          â”‚ â”‚
â”‚  3ï¸âƒ£ Create FacebookClient               â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚     new FacebookClient(pageAccessToken)  â”‚  â”‚                                  â”‚
â”‚                                          â”‚  â”‚  UI updates:                     â”‚
â”‚  4ï¸âƒ£ MESSENGER SYNC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚  â”‚  â€¢ Progress bar                  â”‚
â”‚     â”‚                                    â”‚  â”‚  â€¢ "Synced 145 contacts..."      â”‚
â”‚     â”œâ”€ Fetch conversations (with        â”‚  â”‚  â€¢ Time elapsed                  â”‚
â”‚     â”‚  pagination)                       â”‚  â”‚  â€¢ Spinner animation             â”‚
â”‚     â”‚                                    â”‚  â”‚                                  â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     â”‚  â”‚ Page 1: 100 conversations â”‚    â”‚
â”‚     â”‚  â”‚ Page 2: 100 conversations â”‚    â”‚
â”‚     â”‚  â”‚ Page 3: 100 conversations â”‚    â”‚
â”‚     â”‚  â”‚ Page 4: 47 conversations  â”‚    â”‚
â”‚     â”‚  â”‚ Total: 347 conversations  â”‚    â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â”‚                                    â”‚
â”‚     â”œâ”€ For each conversation:           â”‚
â”‚     â”‚  For each participant:             â”‚
â”‚     â”‚                                    â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚  â”‚ 1. Extract Name              â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ From messages            â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ "John Smith" â†’ split     â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Fallback: "User 123456"  â”‚  â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚           â–¼                        â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚  â”‚ 2. Analyze with AI           â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Send to Google AI        â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Get summary & stage      â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ 1-second delay           â”‚  â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚           â–¼                        â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚  â”‚ 3. Save Contact              â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Upsert by PSID           â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Update name, interaction â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Set AI context           â”‚  â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚           â–¼                        â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚  â”‚ 4. Auto-assign to Pipeline   â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ If enabled               â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Match stage by name      â”‚  â”‚
â”‚     â”‚  â”‚    â€¢ Set lead score/status    â”‚  â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚           â–¼                        â”‚
â”‚     â”‚  syncedCount++                    â”‚
â”‚     â”‚  If syncedCount % 10 == 0:        â”‚
â”‚     â”‚    Update job progress in DB      â”‚
â”‚     â”‚                                    â”‚
â”‚  5ï¸âƒ£ INSTAGRAM SYNC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚     (Same process if connected)         â”‚
â”‚                                          â”‚
â”‚  6ï¸âƒ£ Update FacebookPage                â”‚
â”‚     lastSyncedAt = now()                â”‚
â”‚                                          â”‚
â”‚  7ï¸âƒ£ Finalize SyncJob                   â”‚
â”‚     â”œâ”€ status: COMPLETED                â”‚
â”‚     â”œâ”€ syncedContacts: 347              â”‚
â”‚     â”œâ”€ failedContacts: 5                â”‚
â”‚     â”œâ”€ totalContacts: 352               â”‚
â”‚     â”œâ”€ completedAt: now()               â”‚
â”‚     â””â”€ errors: [...]                    â”‚
â”‚                                          â”‚
â”‚  âœ… SYNC COMPLETE                        â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Polling detects status: COMPLETED
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‰ UI FINAL UPDATE                                  â”‚
â”‚                                                      â”‚
â”‚  â€¢ Stop polling                                      â”‚
â”‚  â€¢ Show success toast:                               â”‚
â”‚    "âœ… Synced 347 contacts successfully"             â”‚
â”‚  â€¢ Update page card:                                 â”‚
â”‚    â””â”€ "Last synced: just now"                        â”‚
â”‚  â€¢ Refresh total contacts count                      â”‚
â”‚  â€¢ Remove loading spinner                            â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ Decision Tree: What Happens When

```
User clicks "Sync"
    â”‚
    â”œâ”€ Active sync exists?
    â”‚   â”œâ”€ YES â†’ Return existing jobId, continue polling
    â”‚   â””â”€ NO â†’ Create new job, start sync
    â”‚
    â”œâ”€ Conversations fetched
    â”‚   â”‚
    â”‚   â”œâ”€ For each participant:
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€ Has name in messages?
    â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Use actual name
    â”‚   â”‚   â”‚   â””â”€ NO â†’ Use "User 123456"
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€ Has messages to analyze?
    â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Analyze with AI
    â”‚   â”‚   â”‚   â”‚   â”œâ”€ Auto-pipeline enabled?
    â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Full analysis (stage, score, status)
    â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€ NO â†’ Summary only
    â”‚   â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â”‚   â”œâ”€ AI analysis succeeds?
    â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Save context
    â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€ NO â†’ Continue without context
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â””â”€ NO â†’ Skip AI analysis
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€ Contact exists?
    â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Update existing
    â”‚   â”‚   â”‚   â”‚   â”œâ”€ Update mode: SKIP_EXISTING?
    â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€ YES â†’ Skip pipeline update
    â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€ NO â†’ Re-assign pipeline
    â”‚   â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â””â”€ NO â†’ Create new contact
    â”‚   â”‚   â”‚       â”œâ”€ Auto-assign to pipeline
    â”‚   â”‚   â”‚       â””â”€ Log activity
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€ Save succeeds?
    â”‚   â”‚   â”‚   â”œâ”€ YES â†’ syncedCount++
    â”‚   â”‚   â”‚   â””â”€ NO â†’ failedCount++, log error
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€ syncedCount % 10 == 0?
    â”‚   â”‚       â”œâ”€ YES â†’ Update job progress
    â”‚   â”‚       â””â”€ NO â†’ Continue
    â”‚
    â”œâ”€ Token expired?
    â”‚   â”œâ”€ YES â†’ Mark job FAILED, stop sync
    â”‚   â””â”€ NO â†’ Continue
    â”‚
    â””â”€ All contacts processed
        â”œâ”€ Update lastSyncedAt
        â”œâ”€ Finalize job status
        â””â”€ UI shows completion
```

---

## ğŸ­ State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IDLE      â”‚ User has not clicked sync yet
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ User clicks "Sync"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PENDING   â”‚ Job created, waiting to start
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Sync begins
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IN_PROGRESS â”‚ Actively syncing contacts
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                     â”‚                     â”‚
       â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPLETED  â”‚      â”‚   FAILED    â”‚      â”‚  CANCELLED  â”‚
â”‚             â”‚      â”‚             â”‚      â”‚             â”‚
â”‚ âœ… Success  â”‚      â”‚ âŒ Token    â”‚      â”‚ ğŸ›‘ User     â”‚
â”‚ 347 synced  â”‚      â”‚   expired   â”‚      â”‚   stopped   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                      Back to IDLE
```

---

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FACEBOOK GRAPH API                          â”‚
â”‚                                                                 â”‚
â”‚  /v19.0/{pageId}/conversations                                  â”‚
â”‚  ?fields=participants,updated_time,messages{from,message}       â”‚
â”‚  &limit=100                                                     â”‚
â”‚                                                                 â”‚
â”‚  Returns:                                                       â”‚
â”‚  {                                                              â”‚
â”‚    data: [                                                      â”‚
â”‚      {                                                          â”‚
â”‚        id: "conv123",                                           â”‚
â”‚        participants: {                                          â”‚
â”‚          data: [                                                â”‚
â”‚            { id: "psid_12345" },                                â”‚
â”‚            { id: "psid_67890" }                                 â”‚
â”‚          ]                                                      â”‚
â”‚        },                                                       â”‚
â”‚        messages: {                                              â”‚
â”‚          data: [                                                â”‚
â”‚            {                                                    â”‚
â”‚              from: { id: "psid_12345", name: "John Smith" },    â”‚
â”‚              message: "Hi, I'm interested in your service"      â”‚
â”‚            }                                                    â”‚
â”‚          ]                                                      â”‚
â”‚        },                                                       â”‚
â”‚        updated_time: "2025-11-12T10:30:00Z"                     â”‚
â”‚      }                                                          â”‚
â”‚    ],                                                           â”‚
â”‚    paging: { next: "https://graph.facebook.com/..." }          â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKGROUND SYNC ENGINE                       â”‚
â”‚                                                                 â”‚
â”‚  Extracts:                                                      â”‚
â”‚  â€¢ participant.id = "psid_12345"                                â”‚
â”‚  â€¢ from.name = "John Smith" â†’ split â†’ firstName, lastName       â”‚
â”‚  â€¢ messages = [...conversation history...]                      â”‚
â”‚  â€¢ updated_time = conversation timestamp                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       GOOGLE AI API              â”‚  â”‚      DATABASE (PostgreSQL)       â”‚
â”‚                                  â”‚  â”‚                                  â”‚
â”‚  POST /v1/models/gemini-2.0-     â”‚  â”‚  Contact.upsert({               â”‚
â”‚       flash-exp:generateContent  â”‚  â”‚    where: {                     â”‚
â”‚                                  â”‚  â”‚      messengerPSID_facebookPageIdâ”‚
â”‚  Input:                          â”‚  â”‚    },                           â”‚
â”‚  "Analyze this conversation:     â”‚  â”‚    create: {                    â”‚
â”‚   John Smith: Hi, I'm interested â”‚  â”‚      messengerPSID,             â”‚
â”‚   ..."                           â”‚  â”‚      firstName: "John",         â”‚
â”‚                                  â”‚  â”‚      lastName: "Smith",         â”‚
â”‚  Returns:                        â”‚  â”‚      hasMessenger: true,        â”‚
â”‚  {                               â”‚  â”‚      aiContext: "...",          â”‚
â”‚    summary: "Customer inquired   â”‚  â”‚      leadScore: 75,             â”‚
â”‚      about pricing...",          â”‚  â”‚      leadStatus: "QUALIFIED",   â”‚
â”‚    recommendedStage: "Qualified  â”‚  â”‚      pipelineId: "...",         â”‚
â”‚      Lead",                      â”‚  â”‚      stageId: "..."             â”‚
â”‚    leadScore: 75,                â”‚  â”‚    },                           â”‚
â”‚    leadStatus: "QUALIFIED",      â”‚  â”‚    update: { ... }              â”‚
â”‚    confidence: 85,               â”‚  â”‚  })                             â”‚
â”‚    reasoning: "Customer showed   â”‚  â”‚                                  â”‚
â”‚      strong intent"              â”‚  â”‚  SyncJob.update({               â”‚
â”‚  }                               â”‚  â”‚    syncedContacts: ++            â”‚
â”‚                                  â”‚  â”‚  })                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                  â”‚
                 â”‚                    â”‚  ContactActivity.create({        â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    type: "STAGE_CHANGED",       â”‚
                                      â”‚    description: "AI auto-       â”‚
                                      â”‚      assigned..."               â”‚
                                      â”‚  })                             â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Polling & Recovery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI COMPONENT LIFECYCLE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Component Mounts
    â”‚
    â”œâ”€ Fetch connected pages
    â”‚
    â”œâ”€ For each page:
    â”‚   â””â”€ checkLatestSyncJob()
    â”‚       â”œâ”€ GET /api/facebook/pages/{pageId}/latest-sync
    â”‚       â”œâ”€ If job status is PENDING or IN_PROGRESS:
    â”‚       â”‚   â””â”€ Add to activeSyncJobs
    â”‚       â””â”€ Start polling
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         POLLING LOOP                                 â”‚
â”‚                                                                      â”‚
â”‚  setInterval(() => {                                                â”‚
â”‚    if (!isTabVisible) return; // Pause when tab inactive            â”‚
â”‚                                                                      â”‚
â”‚    for (const [pageId, job] of activeSyncJobs) {                    â”‚
â”‚      if (!job.completedAt) {                                        â”‚
â”‚        const updated = await fetch(                                 â”‚
â”‚          `/api/facebook/sync-status/${job.id}`                      â”‚
â”‚        );                                                           â”‚
â”‚                                                                      â”‚
â”‚        if (updated.status === 'COMPLETED') {                        â”‚
â”‚          showSuccessToast();                                        â”‚
â”‚          refreshContactsCount();                                    â”‚
â”‚          removeFromActiveSyncJobs();                                â”‚
â”‚        }                                                            â”‚
â”‚      }                                                              â”‚
â”‚    }                                                                â”‚
â”‚  }, 2000); // Every 2 seconds                                       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Tab becomes inactive
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PAUSED STATE                                      â”‚
â”‚                                                                      â”‚
â”‚  â€¢ Polling stops (no API calls)                                     â”‚
â”‚  â€¢ UI shows "Tab inactive" indicator                                â”‚
â”‚  â€¢ Sync continues on server (unaffected)                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Tab becomes active again
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RESUME STATE                                      â”‚
â”‚                                                                      â”‚
â”‚  â€¢ Immediately poll current status                                  â”‚
â”‚  â€¢ Resume 2-second polling                                          â”‚
â”‚  â€¢ Update UI with latest progress                                   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User closes tab/browser
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server continues syncing (not affected by client)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User returns later & opens integrations page
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Component mounts again                                              â”‚
â”‚  â””â”€ checkLatestSyncJob() finds in-progress job                       â”‚
â”‚      â””â”€ Resumes polling seamlessly                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Feature Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FACEBOOK PAGE SYNCING                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                      â”‚
                              â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CONTACT MANAGEMENT         â”‚   â”‚  PIPELINE SYSTEM         â”‚
        â”‚                             â”‚   â”‚                          â”‚
        â”‚  â€¢ Creates/updates contacts â”‚â—„â”€â”€â”¤  â€¢ Auto-assignment       â”‚
        â”‚  â€¢ Stores AI context        â”‚   â”‚  â€¢ Stage tracking        â”‚
        â”‚  â€¢ Platform identifiers     â”‚   â”‚  â€¢ Lead scoring          â”‚
        â”‚  â€¢ Last interaction         â”‚   â”‚  â€¢ Activity logging      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                      â”‚
                              â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CAMPAIGN SYSTEM            â”‚   â”‚  AI ANALYSIS             â”‚
        â”‚                             â”‚   â”‚                          â”‚
        â”‚  â€¢ Target synced contacts   â”‚   â”‚  â€¢ Conversation summary  â”‚
        â”‚  â€¢ Send bulk messages       â”‚   â”‚  â€¢ Stage recommendation  â”‚
        â”‚  â€¢ Track engagement         â”‚   â”‚  â€¢ Lead qualification    â”‚
        â”‚  â€¢ Filter by tags/stages    â”‚   â”‚  â€¢ Confidence scoring    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  WEBHOOK SYSTEM             â”‚
        â”‚                             â”‚
        â”‚  â€¢ Real-time updates        â”‚
        â”‚  â€¢ Message delivery status  â”‚
        â”‚  â€¢ Read receipts            â”‚
        â”‚  â€¢ Incoming messages        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security & Token Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OAUTH FLOW                                â”‚
â”‚                                                              â”‚
â”‚  1. User clicks "Connect with Facebook"                      â”‚
â”‚     â”œâ”€ Generate state token (CSRF protection)                â”‚
â”‚     â””â”€ Redirect to Facebook OAuth                            â”‚
â”‚                                                              â”‚
â”‚  2. User grants permissions                                  â”‚
â”‚     â”œâ”€ pages_manage_metadata                                 â”‚
â”‚     â”œâ”€ pages_messaging                                       â”‚
â”‚     â”œâ”€ pages_read_engagement                                 â”‚
â”‚     â””â”€ instagram_basic                                       â”‚
â”‚                                                              â”‚
â”‚  3. Facebook redirects back with code                        â”‚
â”‚     â”œâ”€ Exchange code for user access token                   â”‚
â”‚     â””â”€ Use token to get page access tokens                   â”‚
â”‚                                                              â”‚
â”‚  4. Store page access tokens                                 â”‚
â”‚     â”œâ”€ In database (should be encrypted in production)       â”‚
â”‚     â””â”€ Used for all API calls                                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SYNC USES TOKEN                             â”‚
â”‚                                                              â”‚
â”‚  FacebookClient initialized with pageAccessToken             â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ getMessengerConversations(pageId)                     â”‚
â”‚     â”‚   Authorization: Bearer {pageAccessToken}             â”‚
â”‚     â”‚                                                        â”‚
â”‚     â”œâ”€ Token valid? â†’ Continue sync                          â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€ Token expired (code 190)?                             â”‚
â”‚         â”œâ”€ Stop sync immediately                             â”‚
â”‚         â”œâ”€ Mark job as FAILED                                â”‚
â”‚         â”œâ”€ Set tokenExpired flag                             â”‚
â”‚         â””â”€ UI shows "Reconnect required"                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*Visual documentation for Facebook Page Syncing System*
*Last Updated: November 12, 2025*

